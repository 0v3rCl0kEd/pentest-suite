$(document).ready(() => {
    handleForm();
});

const handleForm = () => {
    $("#search-form").submit((e) => {
        e.preventDefault();
        const data = $("#search").val();
        $.ajax({
            url: `/portscanner/retrieve_ip/${data}`,
            type: "get",
            success: (data) => {
                console.log(data);
                buildTable(data);
            },
            statusCode: {
                420: () => {
                    $("#response").text("Fetching...");
                    const cancel = setInterval(() => {
                        $.ajax({
                            url: `/portscanner/check_ip/${data}`,
                            type: "get",
                            success: (data) => {
                                console.log(data[data.length - 1]);
                                buildTable(data);
                                clearInterval(cancel);
                            },
                        });
                    }, 1000)
                }
            }
        });
    });
};

const buildTable = (data) => {
    let html = `<table class="table"><thead><tr><th scope="col">#</th><th scope="col">Port</th></tr></thead><tbody>`;

    for (let i = 0; i < data[data.length - 1].openPorts.length; i++) {
        const port = data[data.length - 1].openPorts[i];
        
        html += `<tr><td>${i}</td><td>${port}</td></tr>`;
    }

    html += "</tbody></table>";

    $("#response").html(html);
};