package sherlock

import (
	"encoding/csv"
	"github.com/0v3rCl0kEd/pentest-suite/scanner/internal/utils/filetools"
	"io"
	"os"
	"os/exec"
	"path"
)

var (
	Path = path.Join(filetools.AppPath(), "sherlock")
	Tool = path.Join(Path, "sherlock-master")
)

func NewScan(username string) *Task {
	cmd := exec.Command("python3", "sherlock", "--fo", Path, "--csv", "--nsfw", username)
	cmd.Dir = Tool

	task := &Task{
		cmd:      cmd,
		c:        make(chan struct{}, 1),
		username: username,
	}

	go func() {
		task.cmd.Run()
		task.c <- struct{}{}
	}()

	return task
}

func (task *Task) IsDone() bool {
	if len(task.c) == 1 {
		return true
	}
	return false
}

func (task *Task) GetData() []Result {
	var results []Result

	fp := path.Join(Path, task.username+".csv")
	f, err := os.Open(fp)
	if err != nil {
		panic(err)
	}

	csvReader := csv.NewReader(f)
	for {
		field, err := csvReader.Read()
		if err == io.EOF {
			break
		}

		results = append(results, Result{
			Username:   field[0],
			Name:       field[1],
			UrlMain:    field[2],
			UrlUser:    field[3],
			Exists:     field[4],
			HttpStatus: field[5],
		})
	}

	f.Close()
	os.Remove(fp)
	os.Remove(path.Join(Path, task.username+".txt"))

	return results
}
