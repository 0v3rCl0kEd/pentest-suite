package sherlock

import (
	"context"
	"fmt"
	"github.com/0v3rCl0kEd/pentest-suite/scanner/internal/db"
	"go.mongodb.org/mongo-driver/mongo"
	"time"
)

var (
	DB              *mongo.Database
	scansCollection *mongo.Collection
	dbCtx           context.Context
)

func SetupDB() {
	DB = db.GetDB()
	dbCtx = context.TODO()
	scansCollection = DB.Collection("sherlock")
}

func SaveResults(res []Result) {
	if len(res) == 0 {
		return
	}
	var results []interface{}

	for i, result := range res {
		// res[0] is csv header(not needed)
		if i == 0 {
			continue
		}
		results = append(results, result)
	}

	scan := &Scan{
		Username: res[1].Username,
		Date:     time.Now(),
		Results:  results,
	}

	insertResult, err := scansCollection.InsertOne(dbCtx, scan)
	if err != nil {
		panic(err)
	}

	fmt.Println(insertResult.InsertedID)
}
