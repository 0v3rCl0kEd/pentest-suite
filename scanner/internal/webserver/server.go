package webserver

import (
	"github.com/0v3rCl0kEd/pentest-suite/scanner/internal/modules/sherlock"
	"github.com/gofiber/fiber/v2"
	"log"
	"time"
)

var Tasks []*sherlock.Task

func Initialize() {
	go WatchTasks()

	app := fiber.New()

	app.Get("/scan/sherlock/:username", func(c *fiber.Ctx) error {
		scan := sherlock.NewScan(c.Params("username"))
		Tasks = append(Tasks, scan)
		return c.SendStatus(200)
	})

	log.Fatal(app.Listen(":3000"))
}

func WatchTasks() {
	for {
		for i, task := range Tasks {
			if task.IsDone() {
				res := task.GetData()
				sherlock.SaveResults(res)
				Tasks = removeTask(Tasks, i)
			}
		}
		time.Sleep(1 * time.Second)
	}
}

func removeTask(s []*sherlock.Task, i int) []*sherlock.Task {
	s[i] = s[len(s)-1]
	return s[:len(s)-1]
}
